name: Deploy Supabase Functions

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Edge Functions
        run: |
          echo "üöÄ Deploying Supabase Edge Functions..."
          
          # Read the function code
          FUNCTION_CODE=$(cat supabase/functions/send-welcome-email/index.ts)
          
          # Deploy using Supabase Management API
          curl -X POST \
            "https://api.supabase.com/v1/projects/${{ secrets.SUPABASE_PROJECT_REF }}/functions/send-welcome-email" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"code\": \"$FUNCTION_CODE\"}" \
            || echo "‚ö†Ô∏è Function deployment failed - check Supabase Dashboard"
          
          echo "‚úÖ Deployment completed!"
          echo "üìä Monitor at: https://supabase.com/dashboard/project/${{ secrets.SUPABASE_PROJECT_REF }}/functions"

  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Functions
        run: |
          echo "üîç Validating functions for PR..."
          
          # Check if function file exists
          if [ -f "supabase/functions/send-welcome-email/index.ts" ]; then
            echo "‚úÖ Function file exists"
            echo "üìã Function size: $(wc -c < supabase/functions/send-welcome-email/index.ts) bytes"
          else
            echo "‚ùå Function file not found"
            exit 1
          fi
          
          echo "‚úÖ Functions validation completed!"
          echo "üìã Ready for deployment to master branch" 